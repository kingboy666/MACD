# MACD 智能交易机器人

## 项目简介
基于 MACD(6,32,9) 策略的智能加密货币交易机器人，具备 ATR 动态止盈止损、智能杠杆分配和多仓位管理功能。

## 核心功能

### 📈 交易策略
- **MACD(6,32,9)** 技术指标
- **ADX** 趋势强度识别
- **30分钟** 时间框架
- 金叉做多，死叉平仓（做空相反）

### 🛡️ 风险管理
- **ATR 动态止盈止损**
  - 止损倍数：2.0x ATR
  - 止盈倍数：3.0x ATR
  - 利润保护机制
- **移动止盈**：保护已实现利润
- **智能仓位分配**：使用余额80%

### ⚡ 智能杠杆系统
- **BTC**：最大100倍杠杆，最低20倍
- **ETH**：最大50倍杠杆，最低20倍
- **主流币**：最大30倍杠杆，最低20倍
- **其他币种**：最大25倍杠杆，最低20倍
- 根据账户大小和波动性智能调节

### 💰 资金管理
- 使用账户余额的80%进行交易
- **无最小金额限制**：支持0.1U小额交易
- 智能多仓位资金分配
- 统一管理交易所现有持仓

## 技术特性

### 🔧 核心组件
- **实时K线数据获取**
- **技术指标计算**（MACD、ADX、ATR）
- **条件单管理**
- **动态止损调整**
- **多线程安全**

### 🌐 交易所支持
- 支持 CCXT 兼容的主流交易所
- 自动同步现有持仓
- 完整的API错误处理

## 部署说明

### Railway 部署
1. Fork 本仓库
2. 连接到 Railway
3. 设置环境变量：
   - `API_KEY`: 交易所API密钥
   - `SECRET_KEY`: 交易所密钥
   - `PASSPHRASE`: API密码（如需要）
4. 部署运行

### 本地运行
```bash
# 安装依赖
pip install -r requirements.txt

# 运行机器人
python main.py
```

## 环境变量配置

```env
# 交易所API配置
API_KEY=your_api_key
SECRET_KEY=your_secret_key
PASSPHRASE=your_passphrase

# 可选配置
SYMBOLS=BTC-USDT,ETH-USDT  # 交易对
MAX_POSITIONS=5            # 最大持仓数
```

## 安全特性

- ✅ 完整的错误处理和重试机制
- ✅ 资金安全保护
- ✅ API密钥安全存储
- ✅ 实时风险监控
- ✅ 详细的交易日志

## 注意事项

⚠️ **风险提示**：
- 加密货币交易存在高风险，可能导致资金损失
- 请在充分了解风险的情况下使用
- 建议先在测试环境中运行
- 不构成投资建议

## 功能完成状态

### ✅ 已完成功能
- **MACD(6,32,9)策略** - 完整实现金叉死叉交易逻辑
- **ATR动态止盈止损** - 2.0x止损，3.0x止盈，利润保护机制
- **智能杠杆系统** - BTC最大100x，ETH最大50x，智能调节
- **胜率统计模块** - 实时计算胜率、盈亏比、连续盈亏等指标
- **历史回测功能** - 支持7-30天历史数据回测分析
- **多仓位资金管理** - 80%资金使用，智能分配策略
- **交易所持仓同步** - 统一管理现有持仓
- **0.1U小额交易** - 无最小金额限制

### 📊 新增统计功能
- **实时胜率计算** - 自动更新交易胜率
- **详细性能指标** - 盈利因子、平均盈亏、最大连续盈亏
- **交易历史记录** - 保存最近100笔交易详情
- **每日回测分析** - 自动进行历史策略验证

### 🔧 技术改进
- **完整的交易循环** - 包含所有必要的交易函数
- **错误处理优化** - 完善的异常处理和重试机制
- **API调用优化** - 合理的调用间隔和限制
- **日志系统完善** - 详细的交易和系统日志

## 更新日志

### v2.1.2 (最新) - 功能完善
- 🚨 **修复缺失函数错误**：添加 `calculate_stop_loss_take_profit` 和 `sync_exchange_positions` 函数
- ✅ **解决Railway运行时错误**：修复"缺少1个必需的位置参数：'atr_value'"错误
- 🔧 **完善交易所持仓同步**：系统启动时自动同步现有持仓到策略管理
- 📊 **增强止盈止损计算**：基于ATR动态计算止盈止损价格，保护利润
- 🚀 **Railway部署完全就绪**：所有功能测试通过，可正常实盘运行

### v2.1.1 - 紧急修复
- 🚨 **紧急修复Railway部署语法错误**
- ✅ 重新创建干净的main.py文件
- ✅ 解决第77行缩进错误问题
- ✅ 清理所有错误的代码分隔符
- ✅ 确保代码可以正常在Railway运行
- 🔧 优化代码结构，移除重复函数
- 📦 Railway部署现已完全就绪

### v2.1.0
- ✨ 新增胜率统计和性能分析模块
- ✨ 添加历史回测功能（7-30天可配置）
- ✨ 完善交易循环和持仓管理
- ✨ 实时交易统计和性能监控
- 🐛 修复函数重复定义问题
- 🐛 优化代码结构和错误处理
- 📊 增加详细的交易记录和分析

### v2.0.0
- ✨ 新增 ATR 动态止盈止损系统
- ✨ 智能杠杆分配功能
- ✨ 多仓位资金管理
- ✨ 交易所持仓同步
- 🐛 修复语法和缩进问题
- 🚀 支持 Railway 一键部署

## 许可证
MIT License

## 联系方式
如有问题或建议，请提交 Issue 或 Pull Request。